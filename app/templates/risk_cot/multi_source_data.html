{% extends "base.html" %}

{% block title %}多源数据 - 金融风控AI系统{% endblock %}

{% block header %}
<div class="flex items-center gap-4 w-full">
    <h2 class="text-[11px] font-semibold text-slate-500 flex items-center gap-2">
    <span>数据管理</span>
    <span class="text-slate-700">/</span>
    <span class="text-slate-500 uppercase tracking-wider">多源数据</span>
    </h2>
</div>
{% endblock %}

{% block content %}
<div class="max-w-[1400px] mx-auto w-full space-y-8" x-data="multiSourceDataApp()">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-900 tracking-tight">多源数据管理</h1>
            <p class="text-slate-500 text-sm mt-1">集成多源数据，提供数据类型统计与分析结果展示</p>
        </div>
        <div class="flex items-center gap-3">
            <button @click="refreshData" 
                    :disabled="loading"
                    class="px-4 py-2 bg-white border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-[18px]" :class="{'animate-spin': loading}">refresh</span>
                刷新数据
            </button>

        </div>
    </div>

    <!-- Data Overview Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-medium mb-1">样本量</p>
                    <h3 class="text-2xl font-bold text-slate-900" x-text="dataOverview.sampleCount || '0'">0</h3>
                </div>
                <div class="size-10 rounded-xl bg-blue-50 flex items-center justify-center text-primary">
                    <span class="material-symbols-outlined text-[20px]">people</span>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-medium mb-1">特征数</p>
                    <h3 class="text-2xl font-bold text-slate-900" x-text="dataOverview.featureCount || '0'">0</h3>
                </div>
                <div class="size-10 rounded-xl bg-green-50 flex items-center justify-center text-green-600">
                    <span class="material-symbols-outlined text-[20px]">calculate</span>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-medium mb-1">数据完整性</p>
                    <h3 class="text-2xl font-bold text-slate-900" x-text="dataOverview.completeness || '0%'">0%</h3>
                </div>
                <div class="size-10 rounded-xl bg-yellow-50 flex items-center justify-center text-yellow-600">
                    <span class="material-symbols-outlined text-[20px]">check_circle</span>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div>
                    <p class="text-slate-500 text-xs font-medium mb-1">数据类型数</p>
                    <h3 class="text-2xl font-bold text-slate-900" x-text="dataOverview.dataTypeCount || '0'">0</h3>
                </div>
                <div class="size-10 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                    <span class="material-symbols-outlined text-[20px]">category</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Type Statistics Module -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-8 py-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-bold text-slate-900">数据类型统计</h3>
                    <p class="text-slate-500 text-xs mt-1">展示数据集内数据类型的分布统计</p>
                </div>
            </div>

        <div class="p-6">
            <div class="space-y-4" x-show="dataTypes.length > 0">
                <template x-for="(type, index) in visibleDataTypes" :key="index">
                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <div @click="toggleDataTypeDetails(index)" class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="size-8 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600">
                                    <span class="material-symbols-outlined text-[16px]">category</span>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800" x-text="type.type"></h4>
                                    <p class="text-xs text-slate-500">
                                        <span x-text="type.count"></span> 个特征，占比 <span x-text="type.percentage"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400" x-text="type.count"></span>
                                <span class="material-symbols-outlined text-slate-400 transition-transform" :class="{'rotate-180': type.expanded}">expand_more</span>
                            </div>
                        </div>
                        <div x-show="type.expanded" class="border-t border-slate-100 bg-slate-50/50">
                                <div class="p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h5 class="text-sm font-bold text-slate-700">特征详情</h5>
                                        <template x-if="type.features.length > type.maxVisibleFeatures">
                                            <button @click="$event.stopPropagation(); type.showAllFeatures = !type.showAllFeatures" 
                                                    class="text-xs font-medium text-primary hover:text-primary/80 transition-colors flex items-center gap-1">
                                                <span x-text="type.showAllFeatures ? '收起' : '显示全部'"></span>
                                                <span class="material-symbols-outlined text-[14px]">expand_more</span>
                                            </button>
                                        </template>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left text-sm">
                                            <thead class="bg-slate-100 text-slate-600 font-bold">
                                                <tr>
                                                    <th class="px-4 py-2">序号</th>
                                                    <th class="px-4 py-2">英文名称</th>
                                                    <th class="px-4 py-2">中文名称</th>
                                                    <th class="px-4 py-2">描述</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-200">
                                                <template x-for="(feature, idx) in (type.showAllFeatures ? type.features : type.features.slice(0, type.maxVisibleFeatures))" :key="idx">
                                                    <tr class="hover:bg-slate-100/50 transition-colors">
                                                        <td class="px-4 py-2 text-slate-500" x-text="idx + 1"></td>
                                                        <td class="px-4 py-2 font-mono text-slate-700" x-text="feature.en"></td>
                                                        <td class="px-4 py-2 font-medium text-slate-800" x-text="feature.cn"></td>
                                                        <td class="px-4 py-2 text-slate-500 text-xs" x-text="feature.desc || '-'"></td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                    <template x-if="type.features.length > type.maxVisibleFeatures && !type.showAllFeatures">
                                        <div class="mt-3 text-center">
                                            <p class="text-xs text-slate-400" x-text="'仅显示前 ' + type.maxVisibleFeatures + ' 个特征，共 ' + type.features.length + ' 个'"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                    </div>
                </template>
                
                <!-- 扩展按钮 -->
                <div x-show="filteredDataTypes.length > maxVisibleTypes" class="py-6 text-center">
                    <button @click="toggleShowAllDataTypes" 
                            class="group flex items-center gap-2 px-6 py-3 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-600 hover:text-primary hover:border-primary hover:shadow-sm transition-all mx-auto">
                        <span x-text="showAllDataTypes ? '收起结果' : '显示全部数据类型'">显示全部数据类型</span>
                        <span class="material-symbols-outlined text-[16px] group-hover:translate-y-0.5 transition-transform" 
                              :class="{'rotate-180': showAllDataTypes}">expand_more</span>
                    </button>
                </div>
            </div>
            <div x-show="!loading && dataTypes.length === 0" class="py-12 text-center">
                <span class="material-symbols-outlined text-4xl text-slate-300 mb-4 block">dataset</span>
                <p class="text-slate-500 font-medium">暂无数据类型统计信息</p>
                <p class="text-xs text-slate-400 mt-1">请点击刷新数据按钮加载数据</p>
            </div>
            <div x-show="loading" class="py-12 flex justify-center">
                <div class="size-10 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
            </div>
        </div>
    </div>

    <!-- Data Analysis Results Module -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- IQR Analysis -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800 text-sm">IQR数据分布分析</h3>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-400">基于四分位距算法</span>
                    <template x-if="iqrAnalysis.length > maxVisibleIQR">
                        <button @click="toggleShowAllIQR" 
                                class="text-xs font-medium text-primary hover:text-primary/80 transition-colors flex items-center gap-1">
                            <span x-text="showAllIQR ? '收起' : '显示全部'"></span>
                            <span class="material-symbols-outlined text-[14px]">expand_more</span>
                        </button>
                    </template>
                </div>
            </div>
            <div class="p-6">
                <div x-show="!loading && iqrAnalysis.length > 0">
                    <div class="space-y-4">
                        <template x-for="(item, index) in (showAllIQR ? iqrAnalysis : iqrAnalysis.slice(0, maxVisibleIQR))" :key="index">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700" x-text="item.feature"></span>
                                    <span class="text-xs text-slate-500" x-show="item.q1 !== null && item.q3 !== null">
                                        Q1: <span x-text="item.q1"></span>, Q3: <span x-text="item.q3"></span>
                                    </span>
                                    <span class="text-xs text-slate-500" x-show="item.q1 === null || item.q3 === null">
                                        非数值型特征
                                    </span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary rounded-full" :style="`width: ${item.range_percentage || item.rangePercentage}%`" x-show="item.range_percentage !== null || item.rangePercentage !== null"></div>
                                </div>
                                <div class="flex justify-between mt-1" x-show="item.min !== null && item.max !== null">
                                    <span class="text-xs text-slate-400" x-text="item.min"></span>
                                    <span class="text-xs text-slate-400" x-text="item.max"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <template x-if="iqrAnalysis.length > maxVisibleIQR && !showAllIQR">
                        <div class="mt-6 text-center">
                            <p class="text-xs text-slate-400" x-text="'仅显示前 ' + maxVisibleIQR + ' 个，共 ' + iqrAnalysis.length + ' 个'"></p>
                        </div>
                    </template>
                </div>
                <div x-show="!loading && iqrAnalysis.length === 0" class="py-8 text-center">
                    <span class="material-symbols-outlined text-3xl text-slate-300 mb-3 block">bar_chart</span>
                    <p class="text-slate-500 text-sm">暂无IQR分析数据</p>
                </div>
                <div x-show="loading" class="py-8 flex justify-center">
                    <div class="size-8 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
                </div>
            </div>
        </div>



        <!-- Missing Values Distribution -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800 text-sm">缺失值分布</h3>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-400">占比统计</span>
                    <template x-if="missingValues.length > maxVisibleMissingValues">
                        <button @click="toggleShowAllMissingValues" 
                                class="text-xs font-medium text-primary hover:text-primary/80 transition-colors flex items-center gap-1">
                            <span x-text="showAllMissingValues ? '收起' : '显示全部'"></span>
                            <span class="material-symbols-outlined text-[14px]">expand_more</span>
                        </button>
                    </template>
                </div>
            </div>
            <div class="p-6">
                <div x-show="!loading && missingValues.length > 0">
                    <div class="space-y-4">
                        <template x-for="(item, index) in (showAllMissingValues ? missingValues : missingValues.slice(0, maxVisibleMissingValues))" :key="index">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-slate-700" x-text="item.feature"></span>
                                    <span class="text-xs text-slate-500" x-text="item.percentage"></span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-red-500 rounded-full" :style="`width: ${item.percentageValue}%`"></div>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-xs text-slate-400">缺失值: <span x-text="item.count"></span></span>
                                    <span class="text-xs text-slate-400">总样本: <span x-text="item.total"></span></span>
                                </div>
                            </div>
                        </template>
                    </div>
                    <template x-if="missingValues.length > maxVisibleMissingValues && !showAllMissingValues">
                        <div class="mt-6 text-center">
                            <p class="text-xs text-slate-400" x-text="'仅显示前 ' + maxVisibleMissingValues + ' 个，共 ' + missingValues.length + ' 个'"></p>
                        </div>
                    </template>
                </div>
                <div x-show="!loading && missingValues.length === 0" class="py-8 text-center">
                    <span class="material-symbols-outlined text-3xl text-slate-300 mb-3 block">error_outline</span>
                    <p class="text-slate-500 text-sm">暂无缺失值分布数据</p>
                </div>
                <div x-show="loading" class="py-8 flex justify-center">
                    <div class="size-8 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
                </div>
            </div>
        </div>

        <!-- Data Summary -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800 text-sm">数据集整体统计</h3>
                <span class="text-xs text-slate-400">关键指标概览</span>
            </div>
            <div class="p-6">
                <div x-show="!loading && dataSummary">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">样本量</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.sampleCount"></h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">特征数</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.featureCount"></h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">数据完整性</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.completeness"></h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">数值型特征</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.numericFeatures"></h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">分类型特征</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.categoricalFeatures"></h4>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <p class="text-xs text-slate-500 mb-1">文本型特征</p>
                            <h4 class="font-bold text-slate-800" x-text="dataSummary.textFeatures"></h4>
                        </div>
                    </div>
                </div>
                <div x-show="!loading && !dataSummary" class="py-8 text-center">
                    <span class="material-symbols-outlined text-3xl text-slate-300 mb-3 block">summarize</span>
                    <p class="text-slate-500 text-sm">暂无数据集统计数据</p>
                </div>
                <div x-show="loading" class="py-8 flex justify-center">
                    <div class="size-8 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Preview -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h3 class="font-bold text-slate-800 text-sm">数据预览</h3>
            <span class="text-xs text-slate-400">仅展示前 10 行</span>
        </div>
        <div class="p-6">
            <div x-show="!loading && dataPreview.length > 0">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600 font-bold">
                            <tr>
                                <th class="px-4 py-2">序号</th>
                                <template x-for="(column, index) in dataPreviewColumns" :key="index">
                                    <th class="px-4 py-2" x-text="column"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            <template x-for="(row, index) in dataPreview" :key="index">
                                <tr class="hover:bg-slate-100/50 transition-colors">
                                    <td class="px-4 py-2 text-slate-500" x-text="index + 1"></td>
                                    <template x-for="(value, column) in row" :key="column">
                                        <td class="px-4 py-2 text-slate-700" x-text="value"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
            <div x-show="!loading && dataPreview.length === 0" class="py-12 text-center">
                <span class="material-symbols-outlined text-4xl text-slate-300 mb-4 block">table_view</span>
                <p class="text-slate-500 font-medium">暂无预览数据</p>
                <p class="text-xs text-slate-400 mt-1">请点击刷新数据按钮加载数据</p>
            </div>
            <div x-show="loading" class="py-12 flex justify-center">
                <div class="size-10 border-4 border-slate-200 border-t-primary rounded-full animate-spin"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function multiSourceDataApp() {
        return {
            loading: false,
            dataOverview: {
                sampleCount: 0,
                featureCount: 0,
                completeness: '0%',
                dataTypeCount: 0
            },
            dataTypes: [],
            showAllDataTypes: false,
            maxVisibleTypes: 5,
            iqrAnalysis: [],
            showAllIQR: false,
            maxVisibleIQR: 5,
            scoreDistribution: null,
            missingValues: [],
            showAllMissingValues: false,
            maxVisibleMissingValues: 5,
            dataSummary: null,
            dataPreview: [],
            dataPreviewColumns: [],

            init() {
                this.loadData();
            },

            async loadData() {
                this.loading = true;
                try {
                    // 从服务器获取分析结果
                    const response = await fetch('/risk_cot/get_analysis_results');
                    if (!response.ok) {
                        throw new Error('Failed to fetch analysis results');
                    }
                    const data = await response.json();
                    
                    // 填充数据概览
                    this.dataOverview = data.overview ? {
                        sampleCount: data.overview.sample_count || 0,
                        featureCount: data.overview.feature_count || 0,
                        completeness: data.overview.completeness || '0%',
                        dataTypeCount: data.overview.data_type_count || 0
                    } : {
                        sampleCount: 0,
                        featureCount: 0,
                        completeness: '0%',
                        dataTypeCount: 0
                    };
                    
                    // 填充数据预览
                    this.dataPreviewColumns = data.preview ? Object.keys(data.preview[0]) : [];
                    this.dataPreview = data.preview || [];
                    
                    // 填充数据类型统计
                    this.dataTypes = this.processDataTypes(data.data_types, data.field_mapping || data.fieldMapping || {});
                    
                    // 填充IQR分析结果
                    this.iqrAnalysis = data.iqr_and_outliers ? data.iqr_and_outliers.iqr_analysis : [];
                    
                    // 填充缺失值分布
                    this.missingValues = data.data_quality ? data.data_quality.missing_stats : [];
                    
                    // 填充数据汇总
                    this.dataSummary = this.processDataSummary(data);
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: '加载数据失败', type: 'error' } }));
                } finally {
                    this.loading = false;
                }
            },

            async refreshData() {
                await this.loadData();
                window.dispatchEvent(new CustomEvent('notify', { detail: { message: '数据刷新成功', type: 'success' } }));
            },

            processDataTypes(dataTypes, fieldMapping = {}) {
                if (!dataTypes || !dataTypes.type_stats) {
                    return [];
                }
                
                const types = [];
                let typeIndex = 0; // 为每个数据类型分配一个唯一的索引
                
                // 获取所有特征的列表
                const allFeatures = this.dataPreviewColumns || [];
                
                // 为每个数据类型生成特征列表
                for (const [type, stats] of Object.entries(dataTypes.type_stats)) {
                    // 为数值型添加具体说明
                    let typeName = this.mapDataTypeToChinese(type);
                    if (typeName === '数值型') {
                        if (type === 'float64') {
                            typeName = '数值型 (浮点型)';
                        } else if (type === 'int64') {
                            typeName = '数值型 (整型)';
                        }
                    }
                    
                    // 为每个数据类型生成特征列表
                    const featuresCount = stats.count;
                    const features = [];
                    
                    // 尝试为每个数据类型生成不同的特征列表
                    // 这里使用一个简单的算法，为每个数据类型分配不同的特征
                    for (let i = 0; i < featuresCount; i++) {
                        // 计算特征索引，确保每个数据类型的特征索引不同
                        // 使用 typeIndex 作为偏移量，确保每个数据类型的特征索引不同
                        const featureIndex = (i + typeIndex * 10) % allFeatures.length;
                        const featureName = allFeatures[featureIndex] || `feature_${i}_${type}`;
                        // 尝试从字段映射中获取中文名称，如果没有则使用英文名称
                        let chineseName = fieldMapping[featureName] || featureName;
                        features.push({
                            en: featureName,
                            cn: chineseName,
                            desc: `这是一个${typeName}特征` // 实际项目中应该从后端获取描述
                        });
                    }
                    
                    // 如果没有特征，添加一些默认特征
                    if (features.length === 0) {
                        for (let i = 0; i < Math.min(5, featuresCount); i++) {
                            const featureName = `feature_${i}_${type}`;
                            let chineseName = fieldMapping[featureName] || featureName;
                            features.push({
                                en: featureName,
                                cn: chineseName,
                                desc: `这是一个${typeName}特征` // 实际项目中应该从后端获取描述
                            });
                        }
                    }
                    
                    types.push({
                        type: typeName,
                        originalType: type,
                        count: stats.count,
                        percentage: stats.percentage,
                        expanded: false,
                        features: features,
                        showAllFeatures: false,
                        maxVisibleFeatures: 5
                    });
                    
                    // 为每个数据类型增加索引，确保下一个数据类型使用不同的偏移量
                    typeIndex++;
                }
                return types;
            },

            mapDataTypeToChinese(type) {
                const map = {
                    'int64': '数值型',
                    'float64': '数值型',
                    'object': '分类型',
                    'str': '分类型',
                    'bool': '分类型',
                    'datetime64[ns]': '日期型',
                    'timedelta64[ns]': '日期型'
                };
                return map[type] || '其他类型';
            },

            processDataSummary(data) {
                const numericFeatures = data.basic_stats ? data.basic_stats.numeric_features_count : 0;
                const categoricalFeatures = data.data_types ? 
                    (data.data_types.type_stats.str ? data.data_types.type_stats.str.count : 
                     data.data_types.type_stats.object ? data.data_types.type_stats.object.count : 0) : 0;
                const textFeatures = 0; // 暂时设为0，实际应根据数据类型计算
                
                return {
                    sampleCount: data.overview ? data.overview.sample_count : 0,
                    featureCount: data.overview ? data.overview.feature_count : 0,
                    completeness: data.overview ? data.overview.completeness : '0%',
                    numericFeatures: numericFeatures,
                    categoricalFeatures: categoricalFeatures,
                    textFeatures: textFeatures
                };
            },

            toggleDataTypeDetails(index) {
                this.dataTypes[index].expanded = !this.dataTypes[index].expanded;
            },

            get visibleDataTypes() {
                if (this.showAllDataTypes) return this.dataTypes;
                return this.dataTypes.slice(0, this.maxVisibleTypes);
            },

            toggleShowAllDataTypes() {
                this.showAllDataTypes = !this.showAllDataTypes;
            },

            toggleShowAllIQR() {
                this.showAllIQR = !this.showAllIQR;
            },

            toggleShowAllMissingValues() {
                this.showAllMissingValues = !this.showAllMissingValues;
            }
        };
    }
</script>
{% endblock %}
