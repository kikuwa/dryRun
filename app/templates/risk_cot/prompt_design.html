{% extends "base.html" %}

{% block title %}提示词工程与设计 - 金融风控AI系统{% endblock %}

{% block header %}
<div class="flex items-center gap-4 w-full">
    <h2 class="text-[11px] font-semibold text-slate-500 flex items-center gap-2">
    <span>大模型风控</span>
    <span class="text-slate-700">/</span>
    <span class="text-slate-500 uppercase tracking-wider">Prompt Design & Optimization</span>
    </h2>
</div>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col gap-6" x-data="promptDesignApp()">
    
    <!-- Header Summary -->
    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex-none">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">提示词工程/设计模块</h1>
                <p class="text-slate-500 text-sm mt-1">智能优化提示词模板，支持自定义规则库与多维反馈系统。</p>
            </div>
            <div class="flex gap-3">
                <button @click="showFeatureManager = true" class="px-4 py-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-xl text-xs font-bold transition-all flex items-center gap-2 border border-indigo-100">
                    <span class="material-symbols-outlined text-[18px]">list_alt</span> 特征字段管理
                </button>
                <button @click="showRuleManager = true" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-xs font-bold transition-all flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">rule</span> 规则库管理
                </button>
                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                
                <!-- API Key Input -->
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-200">
                    <span class="material-symbols-outlined text-[16px] text-slate-400">key</span>
                    <input type="password" x-model="apiKey" placeholder="输入 DeepSeek API Key" 
                           class="bg-transparent border-none text-xs font-medium text-slate-700 focus:ring-0 w-48"
                           @change="localStorage.setItem('deepseek_api_key', apiKey)">
                </div>

                <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-200">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Model:</span>
                    <select x-model="model" class="bg-transparent border-none text-xs font-bold text-slate-700 focus:ring-0 cursor-pointer">
                        <option value="deepseek-chat">DeepSeek Chat</option>
                        <option value="deepseek-reasoner">DeepSeek Reasoner (R1)</option>
                    </select>
                </div>

                <!-- Comparison Mode Toggle -->
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-xl border transition-all cursor-pointer"
                     :class="comparisonMode ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-slate-50 border-slate-200 text-slate-600'"
                     @click="comparisonMode = !comparisonMode">
                    <span class="material-symbols-outlined text-[18px]">compare</span>
                    <span class="text-[10px] font-bold uppercase tracking-wider">对比预览模式</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Mode View -->
    <template x-if="comparisonMode">
        <div class="flex-1 bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden flex flex-col min-h-0 animate-in fade-in zoom-in duration-300">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h3 class="text-sm font-bold text-slate-800">提示词效果对比 (滑动预览)</h3>
                    <div class="flex gap-4">
                        <span class="flex items-center gap-1.5 text-[10px] font-bold text-slate-400">
                            <span class="size-2 rounded-full bg-slate-400"></span> 原始提示词
                        </span>
                        <span class="flex items-center gap-1.5 text-[10px] font-bold text-indigo-500">
                            <span class="size-2 rounded-full bg-indigo-500"></span> 优化后提示词
                        </span>
                    </div>
                </div>
                <button @click="comparisonMode = false" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="flex-1 relative overflow-hidden bg-slate-900 select-none" 
                 @mousemove="if($event.buttons === 1) comparisonPosition = Math.max(0, Math.min(100, ($event.offsetX / $el.clientWidth) * 100))"
                 @click="comparisonPosition = ($event.offsetX / $el.clientWidth) * 100">
                
                <!-- Left: Original -->
                <div class="absolute inset-0 p-8 overflow-auto custom-scrollbar-dark font-mono text-sm leading-relaxed text-slate-400 whitespace-pre-wrap"
                     x-text="currentOriginalContent || '等待输入原始提示词...'">
                </div>

                <!-- Right: Optimized (Clipped) -->
                <div class="absolute inset-0 p-8 overflow-auto custom-scrollbar-dark font-mono text-sm leading-relaxed text-indigo-300 whitespace-pre-wrap bg-slate-900 border-l border-indigo-500/30 shadow-[-10px_0_30px_rgba(0,0,0,0.5)]"
                     :style="`clip-path: inset(0 0 0 ${comparisonPosition}%); transition: clip-path 0.1s ease-out;`"
                     x-text="optimizedContent || '等待生成优化后的提示词...'">
                </div>

                <!-- Slider Handle -->
                <div class="absolute top-0 bottom-0 w-1 bg-indigo-500 cursor-col-resize z-10 flex items-center justify-center group"
                     :style="`left: ${comparisonPosition}%; transition: left 0.1s ease-out;`"
                     @mousedown.prevent>
                    <div class="size-8 bg-indigo-500 rounded-full shadow-lg flex items-center justify-center text-white border-4 border-slate-900 group-hover:scale-110 transition-transform">
                        <span class="material-symbols-outlined text-[20px]">unfold_more</span>
                    </div>
                </div>
            </div>

            <div class="px-6 py-3 bg-slate-50 border-t border-slate-100 flex justify-center">
                <input type="range" x-model="comparisonPosition" class="w-1/2 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
            </div>
        </div>
    </template>

    <!-- Main Workspace -->
    <div class="flex-1 grid grid-cols-12 gap-6 min-h-0" x-show="!comparisonMode">
        
        <!-- 1. Original Template Area (Now Editable) -->
        <div class="col-span-4 flex flex-col gap-4 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500 text-[20px]">edit_note</span>
                    原始提示词 (可自定义)
                </h3>
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="text-[10px] font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1">
                        参考历史模板 <span class="material-symbols-outlined text-[14px]">expand_more</span>
                    </button>
                    <div x-show="open" @click.away="open = false" 
                         class="absolute right-0 mt-2 w-64 bg-white border border-slate-200 rounded-xl shadow-xl z-20 py-2">
                        <template x-for="tpl in templates" :key="tpl.id">
                            <button @click="selectTemplate(tpl); open = false" 
                                    class="w-full text-left px-4 py-2 hover:bg-slate-50 transition-all">
                                <div class="font-bold text-[11px] text-slate-700" x-text="tpl.name"></div>
                                <div class="text-[9px] text-slate-500 truncate" x-text="tpl.description"></div>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
            <div class="flex-1 flex flex-col p-4 gap-4 overflow-hidden">
                <div class="flex-1 flex flex-col min-h-0">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">在此输入或修改您的提示词</label>
                    <textarea x-model="currentOriginalContent" 
                              class="flex-1 bg-slate-900 rounded-xl p-4 overflow-auto custom-scrollbar font-mono text-[11px] leading-relaxed text-slate-300 whitespace-pre-wrap selection:bg-blue-500/30 border-none focus:ring-2 focus:ring-blue-500/20 outline-none resize-none"
                              placeholder="在此粘贴或编写您想要优化的原始提示词..."></textarea>
                </div>
            </div>
        </div>

        <!-- 2. Optimization Control Area -->
        <div class="col-span-4 flex flex-col gap-4 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-500 text-[20px]">auto_fix</span>
                    提示词优化操作
                </h3>
                <div class="flex gap-2">
                    <button @click="undo" :disabled="historyIndex <= 0" class="p-1.5 text-slate-400 hover:text-slate-600 disabled:opacity-30">
                        <span class="material-symbols-outlined text-[18px]">undo</span>
                    </button>
                    <button @click="redo" :disabled="historyIndex >= history.length - 1" class="p-1.5 text-slate-400 hover:text-slate-600 disabled:opacity-30">
                        <span class="material-symbols-outlined text-[18px]">redo</span>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 custom-scrollbar space-y-6">
                <!-- Optimization Rules -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">优化规则选择</label>
                        <span class="text-[10px] text-slate-400" x-text="`已选 ${selectedRules.length} 个规则`"></span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <template x-for="rule in rules" :key="rule.id">
                            <label class="flex items-start gap-3 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 transition-all cursor-pointer group"
                                   :class="selectedRules.includes(rule.id) ? 'bg-indigo-50/50 border-indigo-200' : ''">
                                <input type="checkbox" :value="rule.id" x-model="selectedRules" class="mt-0.5 rounded text-indigo-600 focus:ring-indigo-500/20 border-slate-300">
                                <div class="flex-1">
                                    <div class="text-[11px] font-bold text-slate-700" x-text="rule.name"></div>
                                    <div class="text-[10px] text-slate-500 mt-0.5" x-text="rule.description"></div>
                                </div>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Opinion System -->
                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">专家改进建议 (意见点选)</label>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="op in opinions" :key="op.id">
                            <button @click="toggleOpinion(op.content)" 
                                    :class="selectedOpinions.includes(op.content) ? 'bg-indigo-600 text-white shadow-indigo-200' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                                    class="px-3 py-1.5 rounded-full text-[10px] font-bold transition-all shadow-sm">
                                <span x-text="op.content"></span>
                            </button>
                        </template>
                        <button @click="showAddOpinion = true" class="px-3 py-1.5 rounded-full border border-dashed border-slate-300 text-slate-400 hover:border-indigo-400 hover:text-indigo-600 text-[10px] font-bold transition-all flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">add</span> 自定义
                        </button>
                    </div>
                </div>

                <!-- Custom Feedback -->
                <div class="space-y-3">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">手动补充要求</label>
                    <textarea x-model="customFeedback" 
                              class="w-full h-24 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none text-xs text-slate-600 resize-none transition-all"
                              placeholder="在此输入额外的优化要求或反馈..."></textarea>
                </div>

                <!-- Action Button -->
                <div class="pt-2">
                    <button @click="optimize" 
                            :disabled="loadingOptimize"
                            class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-indigo-500/30 flex items-center justify-center gap-2 text-sm disabled:opacity-50 transform active:scale-[0.98]">
                        <span class="material-symbols-outlined text-[20px]" :class="{'animate-spin': loadingOptimize}" x-text="loadingOptimize ? 'sync' : 'auto_awesome'">auto_awesome</span>
                        <span x-text="loadingOptimize ? '正在智能优化中...' : '启动 AI 智能优化'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. Result Area -->
        <div class="col-span-4 flex flex-col gap-4 bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-green-500 text-[20px]">verified</span>
                    优化后提示词
                </h3>
                <div class="flex bg-slate-200/50 p-0.5 rounded-lg">
                    <button @click="resultView = 'content'" 
                            class="px-3 py-1 text-[10px] font-bold rounded-md transition-all duration-200"
                            :class="resultView === 'content' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                        预览
                    </button>
                    <button @click="resultView = 'diff'" 
                            class="px-3 py-1 text-[10px] font-bold rounded-md transition-all duration-200"
                            :class="resultView === 'diff' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                        对比 (Diff)
                    </button>
                </div>
            </div>
            
            <div class="flex-1 flex flex-col p-4 gap-4 overflow-hidden">
                <div class="flex-1 bg-slate-50 rounded-xl border border-slate-200 relative group overflow-hidden">
                    <template x-if="resultView === 'content'">
                        <div class="h-full">
                            <textarea x-model="optimizedContent" 
                                      class="w-full h-full p-4 bg-transparent border-none focus:ring-0 text-[11px] font-mono leading-relaxed text-slate-700 custom-scrollbar"
                                      placeholder="优化后的结果将在此显示..."></textarea>
                            <button @click="copyToClipboard(optimizedContent)" 
                                    class="absolute top-3 right-3 p-2 bg-white/80 backdrop-blur rounded-lg shadow-sm border border-slate-200 text-slate-500 hover:text-indigo-600 opacity-0 group-hover:opacity-100 transition-all">
                                <span class="material-symbols-outlined text-[16px]">content_copy</span>
                            </button>
                        </div>
                    </template>
                    
                    <template x-if="resultView === 'diff'">
                        <div class="h-full overflow-auto p-4 font-mono text-[10px] custom-scrollbar">
                            <div class="space-y-1">
                                <template x-if="!optimizedContent">
                                    <div class="text-slate-400 italic">尚未生成优化结果</div>
                                </template>
                                <div class="whitespace-pre-wrap leading-relaxed" x-html="renderDiff()"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button @click="saveTemplate" 
                            :disabled="!optimizedContent"
                            class="bg-white hover:bg-slate-50 text-slate-700 font-bold py-2.5 rounded-xl border border-slate-200 shadow-sm transition-all flex items-center justify-center gap-2 text-xs disabled:opacity-50">
                        <span class="material-symbols-outlined text-[18px]">save</span> 保存新版本
                    </button>
                    <button @click="exportTemplate" 
                            :disabled="!optimizedContent"
                            class="bg-white hover:bg-slate-50 text-slate-700 font-bold py-2.5 rounded-xl border border-slate-200 shadow-sm transition-all flex items-center justify-center gap-2 text-xs disabled:opacity-50">
                        <span class="material-symbols-outlined text-[18px]">download</span> 导出模板
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Manager Modal -->
    <div x-show="showFeatureManager" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm" x-transition>
        <div class="bg-white rounded-3xl w-full max-w-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" @click.away="showFeatureManager = false">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-indigo-50/30">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">样本特征字段管理</h3>
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider mt-0.5">Feature Mapping & Injection</p>
                </div>
                <button @click="showFeatureManager = false" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="flex-1 overflow-hidden flex flex-col p-6 gap-6">
                <!-- Import Area -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">批量导入特征 (格式: 英文名,中文名)</label>
                        <div class="flex gap-3">
                            <button @click="loadSystemFeatures" class="text-[10px] font-bold text-slate-500 hover:text-slate-700 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">sync</span> 加载系统预设
                            </button>
                            <button @click="importFeatures" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-700 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">download</span> 执行解析导入
                            </button>
                        </div>
                    </div>
                    <textarea x-model="featureImportText" 
                              class="w-full h-32 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none text-[11px] font-mono text-slate-600 custom-scrollbar resize-none"
                              placeholder="cust_id,客户编号&#10;total_assets,资产总额&#10;overdue_days,逾期天数..."></textarea>
                </div>

                <!-- Feature List -->
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="flex justify-between items-end mb-3">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest">已解析特征列表 (<span x-text="featureMaps.length"></span>)</label>
                        <button @click="featureMaps = []" class="text-[10px] font-bold text-red-500 hover:text-red-600">清空全部</button>
                    </div>
                    <div class="flex-1 overflow-y-auto border border-slate-100 rounded-2xl custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-slate-50 z-10">
                                <tr>
                                    <th class="px-4 py-2.5 text-[10px] font-bold text-slate-500 border-b border-slate-100">英文名 (ID)</th>
                                    <th class="px-4 py-2.5 text-[10px] font-bold text-slate-500 border-b border-slate-100">中文描述</th>
                                    <th class="px-4 py-2.5 text-right border-b border-slate-100"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(feat, idx) in featureMaps" :key="idx">
                                    <tr class="hover:bg-slate-50/50 transition-colors group">
                                        <td class="px-4 py-2 text-[11px] font-mono text-slate-700" x-text="feat.en_name"></td>
                                        <td class="px-4 py-2 text-[11px] text-slate-600" x-text="feat.zh_name"></td>
                                        <td class="px-4 py-2 text-right">
                                            <button @click="featureMaps.splice(idx, 1)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                                <span class="material-symbols-outlined text-[16px]">delete</span>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <template x-if="featureMaps.length === 0">
                                    <tr>
                                        <td colspan="3" class="px-4 py-12 text-center text-slate-400 italic text-xs">暂无特征数据，请在上方输入并点击“执行解析导入”</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="px-6 py-5 border-t border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <input type="checkbox" x-model="autoInjectFeatures" id="auto-inject" class="rounded text-indigo-600 focus:ring-indigo-500/20">
                    <label for="auto-inject" class="text-[11px] font-medium text-slate-600">在优化时自动注入特征定义</label>
                </div>
                <div class="flex gap-3">
                    <button @click="injectFeaturesToPrompt" 
                            class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-bold hover:bg-slate-50 transition-all shadow-sm">
                        手动注入到提示词
                    </button>
                    <button @click="saveFeatureMaps" 
                            class="px-6 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">
                        保存配置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rule Manager Modal -->
    <div x-show="showRuleManager" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm" x-transition>
        <div class="bg-white rounded-3xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]" @click.away="showRuleManager = false">
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">优化规则库管理</h3>
                <button @click="showRuleManager = false" class="text-slate-400 hover:text-slate-600">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex gap-4">
                        <div class="flex-1 space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <input x-model="newRule.name" placeholder="规则名称" class="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs">
                                <select x-model="newRule.category" class="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs">
                                    <option value="语言风格">语言风格</option>
                                    <option value="结构优化">结构优化</option>
                                    <option value="内容增强">内容增强</option>
                                    <option value="特定场景">特定场景</option>
                                </select>
                            </div>
                            <input x-model="newRule.description" placeholder="规则详细描述..." class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs">
                        </div>
                        <button @click="addRule" class="px-6 bg-blue-600 text-white font-bold rounded-xl text-xs hover:bg-blue-700 transition-all shadow-md shadow-blue-200 shrink-0">
                            新增规则
                        </button>
                    </div>

                    <div class="space-y-2 mt-6">
                        <template x-for="rule in rules" :key="rule.id">
                            <div class="flex items-center justify-between p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[9px] font-bold uppercase tracking-wider" x-text="rule.category"></span>
                                        <span class="text-sm font-bold text-slate-700" x-text="rule.name"></span>
                                    </div>
                                    <p class="text-xs text-slate-500 mt-1" x-text="rule.description"></p>
                                </div>
                                <button @click="deleteRule(rule.id)" class="text-slate-300 hover:text-red-500 transition-colors">
                                    <span class="material-symbols-outlined text-[20px]">delete</span>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Opinion Modal -->
    <div x-show="showAddOpinion" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm" x-transition>
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-xl p-6" @click.away="showAddOpinion = false">
            <h3 class="text-base font-bold text-slate-800 mb-4">添加自定义改进建议</h3>
            <input x-model="newOpinion" @keyup.enter="addOpinion" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none text-sm text-slate-700 mb-4" placeholder="例如：增加输出的解释性...">
            <div class="flex gap-3">
                <button @click="showAddOpinion = false" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-xl text-xs font-bold transition-all">取消</button>
                <button @click="addOpinion" class="flex-1 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-bold transition-all shadow-md shadow-indigo-200">添加</button>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function promptDesignApp() {
        return {
            templates: [],
            rules: [],
            opinions: [],
            selectedTemplateId: null,
            currentOriginalContent: '',
            selectedRules: [],
            selectedOpinions: [],
            customFeedback: '',
            optimizedContent: '',
            loadingOptimize: false,
            resultView: 'content',
            model: 'deepseek-chat',
            comparisonMode: false,
            comparisonPosition: 50,
            apiKey: localStorage.getItem('deepseek_api_key') || '',
            showRuleManager: false,
            showAddOpinion: false,
            showFeatureManager: false,
            autoInjectFeatures: true,
            featureImportText: '',
            featureMaps: [],
            newRule: { name: '', category: '语言风格', description: '' },
            newOpinion: '',
            history: [],
            historyIndex: -1,

            init() {
                this.loadInitialData();
            },

            async loadInitialData() {
                try {
                    const [tplRes, ruleRes, opRes, featRes] = await Promise.all([
                        fetch('/api/prompt_design/templates'),
                        fetch('/api/prompt_design/rules'),
                        fetch('/api/prompt_design/opinions'),
                        fetch('/api/prompt_design/feature_maps')
                    ]);
                    
                    const tplData = await tplRes.json();
                    const ruleData = await ruleRes.json();
                    const opData = await opRes.json();
                    const featData = await featRes.json();

                    this.templates = tplData.templates;
                    this.rules = ruleData.rules;
                    this.opinions = opData.opinions;
                    this.featureMaps = featData.feature_maps || [];

                    if (this.templates.length > 0) {
                        this.selectTemplate(this.templates[0]);
                    }
                } catch (e) {
                    console.error('Failed to load data', e);
                }
            },

            importFeatures() {
                if (!this.featureImportText || !this.featureImportText.trim()) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: '请输入特征内容', type: 'error' } }));
                    return;
                }
                const lines = this.featureImportText.split('\n');
                let count = 0;
                lines.forEach(line => {
                    if (!line.trim()) return;
                    // 支持 英文名,中文名 或 英文名 中文名 (空格/制表符)
                    const parts = line.includes(',') ? line.split(',') : (line.includes('，') ? line.split('，') : line.split(/\s+/));
                    if (parts.length >= 2) {
                        const en = parts[0].trim();
                        const zh = parts[1].trim();
                        if (en && zh && !this.featureMaps.find(f => f.en_name === en)) {
                            this.featureMaps.push({ en_name: en, zh_name: zh });
                            count++;
                        }
                    }
                });
                this.featureImportText = '';
                window.dispatchEvent(new CustomEvent('notify', { detail: { message: `已成功解析并导入 ${count} 个新特征字段` } }));
            },

            async loadSystemFeatures() {
                try {
                    const res = await fetch('/api/prompt_design/feature_maps/system');
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.featureImportText = data.content;
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '系统预设特征已加载到输入框' } }));
                    } else {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: data.message, type: 'error' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            async saveFeatureMaps() {
                try {
                    const res = await fetch('/api/prompt_design/feature_maps', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ feature_maps: this.featureMaps })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '特征配置已保存' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            injectFeaturesToPrompt() {
                if (this.featureMaps.length === 0) return;
                
                let featureDesc = "\n【待分析特征槽位列表】\n";
                this.featureMaps.forEach(f => {
                    featureDesc += `- ${f.zh_name}: {${f.en_name}}\n`;
                });
                
                // Find where to inject. Try to inject before {data_report} or at the end.
                if (this.currentOriginalContent.includes('{data_report}')) {
                    this.currentOriginalContent = this.currentOriginalContent.replace('{data_report}', featureDesc + '\n{data_report}');
                } else {
                    this.currentOriginalContent += featureDesc;
                }
                
                window.dispatchEvent(new CustomEvent('notify', { detail: { message: '特征槽位已注入到原始提示词中' } }));
            },

            selectTemplate(tpl) {
                this.selectedTemplateId = tpl.id;
                this.currentOriginalContent = tpl.content;
                this.saveToHistory();
            },

            toggleOpinion(content) {
                const index = this.selectedOpinions.indexOf(content);
                if (index > -1) {
                    this.selectedOpinions.splice(index, 1);
                } else {
                    this.selectedOpinions.push(content);
                }
            },

            async optimize() {
                if (!this.currentOriginalContent) return;
                
                this.loadingOptimize = true;
                try {
                    const rulesToApply = this.rules.filter(r => this.selectedRules.includes(r.id));
                    
                    let promptToOptimize = this.currentOriginalContent;
                    let featureContext = "";
                    if (this.featureMaps.length > 0) {
                        featureContext = "\n【当前可用的特征字段及其中文名】\n";
                        this.featureMaps.forEach(f => {
                            featureContext += `- ${f.en_name}: ${f.zh_name}\n`;
                        });
                        
                        // 强制要求优化后的提示词包含特征槽位
                        const slotRequirement = `\n请注意：优化后的提示词必须在分析逻辑中引用上述特征，并使用 {特征英文名} 这样的槽位格式。例如：\"分析客户的{total_assets}情况\"。\n`;
                        
                        if (this.autoInjectFeatures) {
                            promptToOptimize = featureContext + slotRequirement + "\n" + promptToOptimize;
                        }
                    }

                    const res = await fetch('/api/prompt_design/optimize', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            original_prompt: promptToOptimize,
                            rules: rulesToApply,
                            opinions: this.selectedOpinions,
                            custom_feedback: this.customFeedback + (featureContext ? "\n请结合提供的特征字段进行优化，并在提示词中使用 {特征名} 占位符。" : ""),
                            model: this.model,
                            api_key: this.apiKey
                        })
                    });
                    
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.optimizedContent = data.optimized_prompt;
                        this.saveToHistory();
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '提示词优化成功' } }));
                    } else {
                        throw new Error(data.message);
                    }
                } catch (e) {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: e.message, type: 'error' } }));
                } finally {
                    this.loadingOptimize = false;
                }
            },

            async addRule() {
                if (!this.newRule.name || !this.newRule.description) return;
                
                try {
                    const res = await fetch('/api/prompt_design/rules', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(this.newRule)
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.newRule = { name: '', category: '语言风格', description: '' };
                        this.loadInitialData();
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '规则已成功添加' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            async deleteRule(id) {
                if (!confirm('确定要删除这条规则吗？')) return;
                try {
                    await fetch(`/api/prompt_design/rules/${id}`, { method: 'DELETE' });
                    this.loadInitialData();
                } catch (e) {
                    console.error(e);
                }
            },

            async addOpinion() {
                if (!this.newOpinion) return;
                try {
                    const res = await fetch('/api/prompt_design/opinions', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ content: this.newOpinion })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        this.newOpinion = '';
                        this.showAddOpinion = false;
                        this.loadInitialData();
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            saveToHistory() {
                const state = {
                    selectedRules: [...this.selectedRules],
                    selectedOpinions: [...this.selectedOpinions],
                    customFeedback: this.customFeedback,
                    optimizedContent: this.optimizedContent
                };
                
                // Remove future history if we're in the middle of undoing
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                
                this.history.push(JSON.stringify(state));
                this.historyIndex = this.history.length - 1;
                
                // Limit history size
                if (this.history.length > 50) {
                    this.history.shift();
                    this.historyIndex--;
                }
            },

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.applyState(JSON.parse(this.history[this.historyIndex]));
                }
            },

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.applyState(JSON.parse(this.history[this.historyIndex]));
                }
            },

            applyState(state) {
                this.selectedRules = state.selectedRules;
                this.selectedOpinions = state.selectedOpinions;
                this.customFeedback = state.customFeedback;
                this.optimizedContent = state.optimizedContent;
            },

            renderDiff() {
                if (!this.optimizedContent) return '';
                
                // Simple line-based diff for demonstration
                const originalLines = this.currentOriginalContent.split('\n');
                const optimizedLines = this.optimizedContent.split('\n');
                let html = '';
                
                const maxLines = Math.max(originalLines.length, optimizedLines.length);
                for (let i = 0; i < maxLines; i++) {
                    const oldLine = originalLines[i] || '';
                    const newLine = optimizedLines[i] || '';
                    
                    if (oldLine === newLine) {
                        html += `<div class="text-slate-500">${this.escapeHtml(newLine)}</div>`;
                    } else {
                        if (oldLine) html += `<div class="bg-red-50 text-red-600 line-through decoration-red-300/50">- ${this.escapeHtml(oldLine)}</div>`;
                        if (newLine) html += `<div class="bg-green-50 text-green-700 font-bold">+ ${this.escapeHtml(newLine)}</div>`;
                    }
                }
                return html;
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    window.dispatchEvent(new CustomEvent('notify', { detail: { message: '内容已复制到剪贴板' } }));
                });
            },

            async saveTemplate() {
                if (!this.optimizedContent) return;
                try {
                    const res = await fetch('/api/prompt_design/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            original_id: this.selectedTemplateId,
                            original_content: this.currentOriginalContent,
                            content: this.optimizedContent,
                            rules: this.selectedRules,
                            opinions: this.selectedOpinions
                        })
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        window.dispatchEvent(new CustomEvent('notify', { detail: { message: '优化后的提示词已保存' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            exportTemplate() {
                if (!this.optimizedContent) return;
                const blob = new Blob([this.optimizedContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `optimized_prompt_${new Date().getTime()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };
    }
</script>

<style>
    /* Add any custom styles for diff view or specific transitions here */
    [x-cloak] { display: none !important; }
</style>
{% endblock %}
